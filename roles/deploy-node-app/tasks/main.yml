---
  - name: Create directory under /home/ubuntu for {{ application_name }}
    file: path=/home/ubuntu/{{ application_name }} state=directory mode=755

  # - name: Git checkout from github
  #   git: repo={{ git_repo }}
  #        dest=/home/ubuntu/repos/{{ project_name }}/

  #  - name: Copy post-receive web hook
  #    copy: src=thingy.super.conf dest=/etc/supervisor/conf.d/thingy.conf
  #
#  - name: Drop reverse proxy config for nginx
#    copy: src=site.nginx.conf dest=/etc/nginx/sites-enabled/site.conf
#    notify: restart nginx
  - name: Create the Nginx configuration file without SSL
    template: src=nginx_site_config.j2
              dest=/etc/nginx/sites-enabled/{{ application_name }}
              backup=yes
    notify: reload nginx
    when: nginx_with_ssl is undefined or nginx_with_ssl == false
    tags: nginx

  - name: Restart Nginx
    sudo: yes
    sudo_user: ubuntu
    shell: sudo service nginx restart

  - name: Setup environment
    blockinfile: |
      dest=/etc/environment
      content='{{ bashrc_env_var }}'
    tags: bashrc

#  - name: Set Port Numer
#    shell: sudo -iu ubuntu export PORT={{ nginx_server_port }}

  - name: Get stuff from git
    git: repo=http://{{ githubuser }}:{{ githubpassword }}@{{ git_path }} dest=/home/ubuntu/{{ application_name }} accept_hostkey=yes version={{ git_branch }}

  - name: npm install
    npm: path=/home/ubuntu/{{ application_name }}

  - name: npm install bower -g
    npm: name=bower global=yes

  - name: bower install
    bower: path=/home/ubuntu/{{ application_name }}

  - name: Start process with pm2
    sudo: yes
    sudo_user: ubuntu
    shell: chdir=/home/ubuntu/{{ application_name }} {{ pm2_start_var }} pm2 start {{app_js}} --name "app"
    tags: pm2start
  #- name: Add env_var
  #  shell: export ENV_VAR=production

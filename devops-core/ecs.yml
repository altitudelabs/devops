# Creates new Ubuntu instance for Metisa

---
# Effectively lifted from the Ansible documentation on EC2:
# http://docs.ansible.com/ec2_module.html
  - name: Start an ECS
    hosts: local
    connection: local
    gather_facts: False
    tags: provisioning
    vars:
      instance_type: t2.micro
      security_group: default
      image: ami-0cb0786f
      region: ap-southeast-1
      user_data: |
        #!/bin/bash
        echo ECS_CLUSTER={{ project_name }} >> /etc/ecs/ecs.config
    vars_files:
      - env_vars/base.yml
    tasks:
      - name: Lookup launched host
        debug: msg={{ groups['staging']==[] }}
        register: stagingGroupisEmpty

      - name: Lookup launched host
        debug: msg={{ groups['production']==[] }}
        register: productionGroupisEmpty

      - name: Create ECS
        local_action: ecs_cluster name={{ project_name }} state=present region='{{ region }}'
        register: ecs
      - debug: var=ecs


      - name: Launch new Staging Instance
        local_action: ec2 instance_tags="Name={{ project_name }},Type=staging" group={{ security_group }} instance_type={{ instance_type}} instance_profile_name='ecsInstanceRole' image={{ image }} wait=yes region={{ region }} user_data="{{ user_data }}" keypair={{ keypair }}
        register: ec2Staging
      - name: Add staging instance to staging group
        add_host: name={{ item.public_ip }} groups=staging ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem
        with_items: ec2Staging.instances
        when: stagingGroupisEmpty.msg
      - name: Add staging instance to host file
        local_action: lineinfile dest="{{ host_file_path }}" regexp="{{ item.public_ip }}" insertafter="\[staging\]" line="{{ item.public_ip }} ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem"
        with_items: ec2Staging.instances
        when: stagingGroupisEmpty.msg

      - name: Launch new Production Instance
        local_action: ec2 instance_tags="Name={{ project_name }},Type=production" group={{ security_group }} instance_type={{ instance_type}} instance_profile_name='ecsInstanceRole' image={{ image }} wait=yes region={{ region }} user_data="{{ user_data }}" keypair={{ keypair }}
        register: ec2Production
        when: productionGroupisEmpty.msg
      - name: Add production instance to production group
        add_host: name={{ item.public_ip }} groups=production ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem
        with_items: ec2Production.instances
        when: productionGroupisEmpty.msg
      - name: Add production instance to host file
        local_action: lineinfile dest="{{ host_file_path }}" regexp="{{ item.public_ip }}" insertafter="\[production\]" line="{{ item.public_ip }} ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem"
        with_items: ec2Production.instances
        when: productionGroupisEmpty.msg

      # Wait SSH
      - name: Wait for staging SSH to come up
        local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: ec2Staging.instances
        when: stagingGroupisEmpty.msg

      - name: Wait for production SSH to come up
        local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: ec2Production.instances
        when: productionGroupisEmpty.msg

      # Wait SSH
      - name: Wait for staging SSH to come up
        local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: ec2Staging.instances
        when: stagingGroupisEmpty.msg

      - name: Wait for production SSH to come up
        local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: ec2Production.instances
        when: productionGroupisEmpty.msg

# Creates new Ubuntu instance for Metisa

---
# Effectively lifted from the Ansible documentation on EC2:
# http://docs.ansible.com/ec2_module.html
  - name: Provision an EC2 node
    hosts: local
    connection: local
    gather_facts: False
    tags: provisioning
    vars:
      instance_type: t2.micro
      security_group: default
      image: ami-96f1c1c4
      region: ap-southeast-1
    vars_files:
      - env_vars/base.yml
    tasks:
      - name: Get instance with same name
        ec2_remote_facts:
          region: '{{ region }}'
          filters:
            instance-state-name: running
            "tag:Name": '{{ instance_name }}'
        register: ec2_exist

      - debug: msg='Instance name - <{{ instance_name }}> already exists!'
        when: "ec2_exist.instances != []"

      - debug: msg='Instance name - <{{ instance_name }}> is not exists.'
        when: "ec2_exist.instances == []"

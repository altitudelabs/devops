---
  - name: Lookup launched host
    debug: msg={{ groups['launched'] }}
    register: launchedGroup

  - name: Do you want to add it into host file?
    pause: prompt="Instance name - <{{ instance_name }}> ({{ ip_address }}) already exists! Press return to add {{ip_address}} to your hosts file, or 'Ctrl+C' and press 'A' to absorb"
    when: "ip_address not in launchedGroup.msg"

  - name: ipaddress exists
    debug: msg="{{ ip_address }} is already in hosts file"
    when: "ip_address in launchedGroup.msg"

  - name: Add instance to local host group
    add_host: name={{ ip_address }} groups=launched ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem
    when: "ip_address not in launchedGroup.msg"

  - name: Add instance to local host file
    local_action: lineinfile dest="{{ host_file_path }}" regexp="{{ ip_address }}" insertafter="[launched]" line="{{ ip_address }} ansible_ssh_private_key_file=~/.ssh/{{ keypair }}.pem"
    when: "ip_address not in launchedGroup.msg"

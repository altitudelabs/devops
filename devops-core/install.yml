---
  - name: With the newly provisioned EC2 node configure that thing
    hosts: launched # This uses the hosts that we put into the in-memory hosts repository with the add_host module.
    become: yes # On EC2 nodes, this is automatically passwordless.
    remote_user: ubuntu # This is the username for all ubuntu images, rather than root, or something weird.
    gather_facts: True  #We need to re-enable this, as we turned it off earlier.
    vars_files:
      - env_vars/base.yml
    roles:
      - common
      # - install-vm-dependencies
      - { role: nodejs, tags: ['nodejs'], when: vm_dependencies.nodejs is defined }
      - { role: mongodb, tags: ['mongodb'], when: vm_dependencies.mongodb is defined }
      - { role: mysql, tags: ['mysql'], when: vm_dependencies.mysql is defined }
      - { role: pm2, tags: ['pm2'] }

  - name: Deploy
    hosts: launched # This uses the hosts that we put into the in-memory hosts repository with the add_host module.
    become: yes # On EC2 nodes, this is automatically passwordless.
    remote_user: ubuntu # This is the username for all ubuntu images, rather than root, or something weird.
    gather_facts: True  #We need to re-enable this, as we turned it off earlier.
    vars_files:
      - env_vars/base.yml
    roles:
      - { role: deploy-node-app, tags: ['deploy'] }

  - name: Open url in browser
    hosts: local
    connection: local
    gather_facts: True
    tasks:
      - shell: open "http://{{ hostvars[item]['inventory_hostname'] }}"
        with_items: groups['launched']
